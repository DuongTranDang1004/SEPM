<script src="https://cdn.tailwindcss.com"></script>
<script>
    // Tailwind CSS configuration for the interface
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                colors: {
                    'primary-blue': '#1e40af',
                    'primary-green': '#10b981',
                    'bg-dark': '#f3f4f6',
                }
            }
        }
    }
</script>

<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
    }

    .card {
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }
    .question-answer-container {
        border-bottom: 1px solid #e5e7eb; /* Light gray separator */
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }
    .question-answer-container:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    .whitespace-pre-wrap {
        white-space: pre-wrap;
    }
</style>

<div class="p-6 md:p-10 min-h-screen flex flex-col items-center">
    <h1 class="text-3xl font-bold text-primary-blue mb-6">Broomate AI Matchmaker üßë‚Äçü§ù‚Äçüßë</h1>
    <p class="text-gray-600 mb-8 max-w-2xl text-center">Uses the Gemini API to evaluate compatibility between two profiles, implementing conditional follow-up questions based on Vietnamese cultural and lifestyle factors.</p>

    <div class="w-full max-w-4xl bg-white p-6 rounded-xl card">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">User Data Input</h2>
        <div class="grid md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Client 1 Profile (The Host/Asker)</label>
                <textarea id="client1Profile" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" placeholder="Information about Client 1..."></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Client 2 Profile (The Potential Roommate/Answerer)</label>
                <textarea id="client2Profile" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" placeholder="Information about Client 2..."></textarea>
            </div>
        </div>

        <h2 class="text-xl font-semibold mb-4 text-gray-800">Q&A History (Current Conversation)</h2>
        <div id="qaHistory" class="space-y-3 bg-gray-50 p-4 rounded-lg border border-gray-200 h-64 overflow-y-auto mb-4">
            <p class="text-gray-500 italic">No questions have been asked yet. Click 'Start' to begin.</p>
        </div>
        <div id="answerWarning" class="hidden p-3 mb-4 rounded-lg bg-red-100 text-red-700 font-medium">
            Please answer all outstanding questions before clicking 'Continue'.
        </div>

        <div class="flex space-x-4 mt-4">
            <button id="startAgent1" class="flex-1 px-4 py-2 bg-primary-green text-white font-medium rounded-lg hover:bg-green-600 transition duration-150 disabled:bg-gray-400" onclick="startMatching()">
                Start (Agent 1: Generate 5 Questions)
            </button>
            <button id="continueAgent2" class="flex-1 px-4 py-2 bg-yellow-600 text-white font-medium rounded-lg hover:bg-yellow-700 transition duration-150 disabled:bg-gray-400" onclick="continueMatching()" disabled>
                Continue (Agent 2: Score/Ask More)
            </button>
        </div>
    </div>

    <div class="w-full max-w-4xl mt-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Results and API Output</h2>
        <div id="resultOutput" class="bg-gray-800 text-white p-4 rounded-xl font-mono text-sm whitespace-pre-wrap card min-h-[100px] flex items-center justify-center">
            Awaiting Command...
        </div>

        <div id="loadingIndicator" class="hidden mt-4 text-center text-primary-blue font-medium">
            <svg class="animate-spin h-5 w-5 mr-3 inline text-primary-blue" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            AI is processing the request... (May take a few seconds)
        </div>

        <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center font-medium hidden"></div>
    </div>
</div>

<script type="module">
    // --- IMPORT AI_CompetiableScore.js ---
    import { 
        generateInitialQuestions, 
        scoreCompatibility, 
        generateFollowUpQuestions 
    } from './AI_CompetiableScore.js'; 

    // --- STATE MANAGEMENT ---
    let currentHistory = [];
    let isWaitingForAnswer = false;
    let lastScore = null;

    // --- DOM ELEMENTS (Cached) ---
    const DOM = {
        client1Profile: document.getElementById('client1Profile'),
        client2Profile: document.getElementById('client2Profile'),
        qaHistory: document.getElementById('qaHistory'),
        resultOutput: document.getElementById('resultOutput'),
        startAgent1: document.getElementById('startAgent1'),
        continueAgent2: document.getElementById('continueAgent2'),
        loadingIndicator: document.getElementById('loadingIndicator'),
        statusMessage: document.getElementById('statusMessage'),
        answerWarning: document.getElementById('answerWarning'),
    };

    // --- UI UTILITY FUNCTIONS (Responsible for DOM updates) --- 
    function renderAnswerInputs() {
        DOM.qaHistory.innerHTML = '';
        if (currentHistory.length === 0) {
            DOM.qaHistory.innerHTML = '<p class="text-gray-500 italic">No questions have been asked yet. Click \'Start\' to begin.</p>';
            return;
        }

        let hasUnansweredQuestions = false;

        currentHistory.forEach((item, index) => {
            const container = document.createElement('div');
            container.className = 'question-answer-container';

            const questionElement = document.createElement('p');
            questionElement.className = 'font-semibold text-primary-blue mb-2';
            questionElement.textContent = `Q${index + 1}: ${item.question}`;
            container.appendChild(questionElement);

            if (item.answer) {
                const answerElement = document.createElement('p');
                answerElement.className = 'ml-4 text-gray-700 border-l-2 border-primary-green pl-2 italic text-sm';
                answerElement.textContent = `Client 2 Answer: ${item.answer}`;
                container.style.backgroundColor = '#ecfdf5'; 
                container.appendChild(answerElement);
            } else {
                const answerInput = document.createElement('textarea');
                answerInput.id = `answerInput-${index}`;
                answerInput.className = 'w-full p-2 border border-yellow-400 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 mt-2';
                answerInput.placeholder = 'Type Client 2\'s answer here...';
                answerInput.rows = 2;
                container.appendChild(answerInput);
                container.style.backgroundColor = '#fffbeb'; 
                hasUnansweredQuestions = true;
            }
            DOM.qaHistory.appendChild(container);
        });
        DOM.qaHistory.scrollTop = DOM.qaHistory.scrollHeight;

        DOM.answerWarning.classList.toggle('hidden', !hasUnansweredQuestions);
        DOM.continueAgent2.disabled = !hasUnansweredQuestions;
        isWaitingForAnswer = hasUnansweredQuestions;
    }

    function readAndValidateAnswers() {
        let allAnswered = true;
        currentHistory.forEach((item, index) => {
            if (!item.answer) {
                const inputElement = document.getElementById(`answerInput-${index}`);
                const answerText = inputElement ? inputElement.value.trim() : '';

                if (answerText.length > 0) {
                    item.answer = answerText;
                } else {
                    allAnswered = false;
                }
            }
        });
        DOM.answerWarning.classList.toggle('hidden', allAnswered);
        return allAnswered;
    }

    function toggleLoading(isLoading) {
        DOM.startAgent1.disabled = isLoading || isWaitingForAnswer;
        DOM.continueAgent2.disabled = isLoading || !isWaitingForAnswer;

        DOM.loadingIndicator.classList.toggle('hidden', !isLoading);
        DOM.resultOutput.textContent = isLoading ? 'Processing...' : 'Awaiting Command...';
    }

    // --- AGENT LOGIC FUNCTIONS (Controllers calling API functions) ---

    async function startMatching() {
        const client1Data = DOM.client1Profile.value.trim();
        const client2Data = DOM.client2Profile.value.trim();

        if (!client1Data || !client2Data) {
            alert('Please enter both Client 1 and Client 2 Data before starting.');
            return;
        }

        // Reset state & UI
        currentHistory = [];
        isWaitingForAnswer = true;
        renderAnswerInputs();
        toggleLoading(true);
        DOM.statusMessage.classList.add('hidden');
        lastScore = null;

        try {
            // Call API function
            const apiResult = await generateInitialQuestions(client1Data, client2Data);

            // Update State
            currentHistory = apiResult.Question.map(q => ({ question: q, answer: null }));

            // Update UI
            DOM.resultOutput.textContent = `AGENT 1 (Question Generation) SUCCESS:\n\n${JSON.stringify(apiResult, null, 2)}`;
            DOM.statusMessage.textContent = `5 initial questions (Type: ${apiResult.Type}) generated based on both profiles. Please provide Client 2's answers and click 'Continue'.`;
            DOM.statusMessage.className = 'mt-4 p-3 rounded-lg text-center font-medium bg-blue-100 text-primary-blue';
            DOM.statusMessage.classList.remove('hidden');

            renderAnswerInputs();

        } catch (error) {
            DOM.resultOutput.textContent = error.message;
            isWaitingForAnswer = false;
        } finally {
            toggleLoading(false);
        }
    }

    async function continueMatching() {
        const client1Data = DOM.client1Profile.value.trim();
        const client2Data = DOM.client2Profile.value.trim();

        if (currentHistory.length === 0) {
            alert('Please run Agent 1 first.');
            return;
        }

        // --- STEP 1: READ AND VALIDATE ANSWERS ---
        if (!readAndValidateAnswers()) {
            return;
        }

        renderAnswerInputs(); 

        // --- STEP 2: FORMAT HISTORY STRING FOR API ---
        let historyString = "";
        currentHistory.forEach((item, index) => {
            historyString += `\n[Q${index + 1}]: ${item.question}\n[A${index + 1}]: ${item.answer}`;
        });

        // --- STEP 3: CALL /api/v1/score (Agent 2 - Scoring) ---
        toggleLoading(true);
        DOM.statusMessage.classList.add('hidden');
        isWaitingForAnswer = false;

        try {
            // Call API function
            const apiResult = await scoreCompatibility(client1Data, client2Data, historyString);

            lastScore = apiResult.Score; 

            // --- STEP 4: CLIENT-SIDE LOGIC & UI UPDATE ---
            let reasonText = apiResult.ReasonBulletPoints.map(point => `- ${point}`).join('\n');
            
            DOM.resultOutput.textContent = `AGENT 2 (Initial Score & Reason) SUCCESS:\n\n${JSON.stringify(apiResult, null, 2)}`;

            if (apiResult.Score < 50) {
                // RULE 1: Score < 50 => Auto-Fail (Type: Result)
                DOM.statusMessage.textContent = `‚ùå FINAL DECISION (Score: ${apiResult.Score}/100, Type: ${apiResult.Type}): Compatibility is LOW. Evaluation is complete.\n\nReason:\n${reasonText}`;
                DOM.statusMessage.className = 'mt-4 p-3 rounded-lg text-left font-bold bg-red-100 text-red-800 whitespace-pre-wrap';
                DOM.continueAgent2.disabled = true;

            } else if (apiResult.Score >= 50 && apiResult.Score <= 70) {
                // RULE 2: Score 50-70 => Ask More (Type: Question)
                await handleMidRangeScore(client1Data, client2Data, historyString);

            } else if (apiResult.Score > 70) {
                // RULE 3: Score > 70 => Auto-Pass (Type: Result)
                DOM.statusMessage.textContent = `‚úÖ FINAL DECISION (Score: ${apiResult.Score}/100, Type: ${apiResult.Type}): Compatibility is HIGH. Evaluation is complete.\n\nReason:\n${reasonText}`;
                DOM.statusMessage.className = 'mt-4 p-3 rounded-lg text-left font-bold bg-green-100 text-primary-green whitespace-pre-wrap';
                DOM.continueAgent2.disabled = true;
            } else {
                throw new Error("Score out of range (0-100) or invalid format.");
            }

            DOM.statusMessage.classList.remove('hidden');

        } catch (error) {
            DOM.resultOutput.textContent = error.message;
        } finally {
            toggleLoading(false);
            DOM.continueAgent2.disabled = !isWaitingForAnswer;
        }
    }


    async function handleMidRangeScore(client1Data, client2Data, historyString) {
        // UI update before secondary call
        DOM.resultOutput.textContent += `\n\n--- SECONDARY CALL: Asking for Follow-up Questions (Score: ${lastScore}) ---`;

        try {
            // Call API function
            const followUpResult = await generateFollowUpQuestions(client1Data, client2Data, historyString, lastScore);

            const newQuestions = followUpResult.Question;
            // Update State
            newQuestions.forEach(q => {
                currentHistory.push({ question: q, answer: null });
            });

            // UI Updates
            DOM.resultOutput.textContent += `\n\nSECONDARY CALL RESULT (Questions):\n${JSON.stringify(followUpResult, null, 2)}`;

            renderAnswerInputs(); // Renders new input fields

            isWaitingForAnswer = true;

            DOM.statusMessage.textContent = `‚ö†Ô∏è MID-RANGE SCORE (${lastScore}/100, Type: ${followUpResult.Type}): AI has provided ${newQuestions.length} follow-up questions. Please provide answers and click 'Continue' for final scoring.`;
            DOM.statusMessage.className = 'mt-4 p-3 rounded-lg text-center font-medium bg-yellow-100 text-yellow-800';

        } catch (error) {
            DOM.resultOutput.textContent = error.message;
            isWaitingForAnswer = false;
        }
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Sample data 
        DOM.client1Profile.value = "Name: Nguyen Van A. Age: 22. Job: IT Student. Habits: Sleeps early (10 PM), likes quiet, non-smoker. Budget: 3-4 Million VND/month. Hobby: Playing online games (with headphones) and light cooking. Living Area: Ho Chi Minh City (often hot, crowded streets, motorbike user).";
        DOM.client2Profile.value = "Name: Tran Thi B. Age: 23. Job: Designer. Habits: Sleeps late (1-2 AM), often listens to music with small speakers, uses e-cigarettes on the balcony. Budget: 3.5-4.5 Million VND/month. Hobby: Drawing, watching movies, and occasionally having friends visit on weekends. Living Area: Hanoi (colder winters, complex inner-city structure, prefers public transport/taxi).";
        
        // Expose functions to global scope for HTML onclick attributes
        window.startMatching = startMatching;
        window.continueMatching = continueMatching;
        
        renderAnswerInputs();
    });
</script>